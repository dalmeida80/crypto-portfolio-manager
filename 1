#!/bin/bash

cd ~/workspace/crypto-portfolio-manager

# Get DB user from .env
DB_USER=$(grep DB_USER backend/.env | cut -d '=' -f2 | tr -d '\r')

echo "Using DB_USER: $DB_USER"
echo ""
echo "=== RESET PORTFOLIO - Starting from Dec 1, 2025 ==="
echo ""

echo "Step 1: Current state..."
docker compose exec -T db psql -U $DB_USER -d crypto_portfolio -c "
SELECT COUNT(*) as total_trades FROM trades;
SELECT MIN(\"executedAt\") as oldest, MAX(\"executedAt\") as newest FROM trades;
" 

echo ""
read -p "Do you want to DELETE all trades before Dec 1, 2025? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "Cancelled."
    exit 0
fi

echo ""
echo "Step 2: Deleting old trades..."
docker compose exec -T db psql -U $DB_USER -d crypto_portfolio -c "
DELETE FROM trades WHERE \"executedAt\" < '2025-12-15 00:00:00';
"

echo ""
echo "Step 3: Resetting portfolio values..."
docker compose exec -T db psql -U $DB_USER -d crypto_portfolio -c "
UPDATE portfolios 
SET \"totalInvested\" = 0, 
    \"currentValue\" = 0, 
    \"profitLoss\" = 0,
    \"updatedAt\" = NOW();
"

echo ""
echo "Step 4: Remaining trades..."
docker compose exec -T db psql -U $DB_USER -d crypto_portfolio -c "
SELECT 
  COUNT(*) as remaining_trades,
  MIN(\"executedAt\") as oldest_trade,
  MAX(\"executedAt\") as newest_trade
FROM trades;
"

echo ""
echo "=== RESET COMPLETE ==="
echo ""
echo "Now import trades from Dec 1, 2025:"
echo ""
echo "curl -X POST \"https://danielapp.duckdns.org/api/exchange/portfolios/8615cf5e-58df-4143-8689-ffe684e3bec5/import-all\" \\"
echo "  -H \"Authorization: Bearer \$TOKEN\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d '{\"startDate\": \"2025-12-01T00:00:00.000Z\"}'"
